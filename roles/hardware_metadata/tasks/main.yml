---
# tasks file for hardware_metadata

- name: Gather hardware metadata
  ignore_errors: true
  block:
    - name: Ensure required packages are installed
      apt:
        name:
          - dmidecode
          - pciutils
          - lshw
        state: present
        update_cache: yes
      ignore_errors: true

    - name: Gather system facts
      setup:
        gather_subset:
          - hardware
          - processor
          - memory
      ignore_errors: true

    - name: Get CPU information
      shell: |
        lscpu | grep -E "Model name|Architecture|CPU\(s\)|Thread|Core|Socket|Vendor ID" || echo "{}"
      register: cpu_details
      changed_when: false
      ignore_errors: true

    - name: Get detailed CPU info from dmidecode
      shell: |
        dmidecode -t processor | grep -E "Version|ID|Signature|Max Speed|Current Speed|Core Count|Thread Count|Serial Number" || echo "{}"
      register: cpu_dmidecode
      changed_when: false
      ignore_errors: true

    - name: Get memory information
      shell: |
        dmidecode -t memory | grep -E "Size|Speed|Manufacturer|Serial Number|Part Number|Type:|Locator" | grep -v "No Module Installed" || echo "{}"
      register: memory_details
      changed_when: false
      ignore_errors: true

    - name: Get motherboard information
      shell: |
        dmidecode -t baseboard | grep -E "Manufacturer|Product Name|Version|Serial Number|Asset Tag" || echo "{}"
      register: motherboard_details
      changed_when: false
      ignore_errors: true

    - name: Get BIOS information
      shell: |
        dmidecode -t bios | grep -E "Vendor|Version|Release Date|BIOS Revision|Firmware Revision" || echo "{}"
      register: bios_details
      changed_when: false
      ignore_errors: true

    - name: Get system information and serial number
      shell: |
        dmidecode -t system | grep -E "Manufacturer|Product Name|Version|Serial Number|UUID|SKU Number|Family" || echo "{}"
      register: system_details
      changed_when: false
      ignore_errors: true

    - name: Get GPU/Accelerator information from lspci
      shell: |
        lspci | grep -iE "VGA|3D|Display|NVIDIA|AMD|Intel.*Graphics" || echo ""
      register: gpu_lspci
      changed_when: false
      ignore_errors: true

    - name: Get detailed GPU information from lspci
      shell: |
        lspci -v | grep -iA 20 "VGA\|3D\|Display" || echo ""
      register: gpu_lspci_detailed
      changed_when: false
      ignore_errors: true

    - name: Check for NVIDIA GPUs and get nvidia-smi output
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=index,name,driver_version,pci.bus_id,serial,uuid,memory.total --format=csv,noheader || echo ""
        else
          echo ""
        fi
      register: nvidia_smi_output
      changed_when: false
      ignore_errors: true

    - name: Get NVIDIA driver version
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=driver_version --format=csv,noheader | head -1 || echo ""
        elif [ -f /proc/driver/nvidia/version ]; then
          cat /proc/driver/nvidia/version || echo ""
        elif command -v modinfo &> /dev/null; then
          modinfo nvidia 2>/dev/null | grep -E "^version:" || echo ""
        else
          echo ""
        fi
      register: nvidia_driver_version
      changed_when: false
      ignore_errors: true

    - name: Get CUDA version from nvidia-smi
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=cuda_version --format=csv,noheader | head -1 || echo ""
        else
          echo ""
        fi
      register: cuda_version_smi
      changed_when: false
      ignore_errors: true

    - name: Get CUDA toolkit version from nvcc
      shell: |
        if command -v nvcc &> /dev/null; then
          nvcc --version || echo ""
        else
          echo ""
        fi
      register: cuda_nvcc_version
      changed_when: false
      ignore_errors: true

    - name: Get CUDA runtime version from ldconfig
      shell: |
        ldconfig -p | grep -E "libcudart.so" | head -1 || echo ""
      register: cuda_runtime_version
      changed_when: false
      ignore_errors: true

    - name: Get detailed NVIDIA GPU information
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=index,name,driver_version,pci.bus_id,serial,uuid,memory.total,memory.free,compute_cap,vbios_version,gpu_bus_id,power.limit,clocks.max.sm,clocks.max.memory --format=csv,noheader || echo ""
        else
          echo ""
        fi
      register: nvidia_gpu_detailed
      changed_when: false
      ignore_errors: true

    - name: Get NVIDIA persistence mode status
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=persistence_mode --format=csv,noheader || echo ""
        else
          echo ""
        fi
      register: nvidia_persistence_mode
      changed_when: false
      ignore_errors: true

    - name: Get NVIDIA compute mode
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi --query-gpu=compute_mode --format=csv,noheader || echo ""
        else
          echo ""
        fi
      register: nvidia_compute_mode
      changed_when: false
      ignore_errors: true

    - name: Get NVIDIA GPU topology
      shell: |
        if command -v nvidia-smi &> /dev/null; then
          nvidia-smi topo -m || echo ""
        else
          echo ""
        fi
      register: nvidia_topology
      changed_when: false
      ignore_errors: true

    - name: Get AMD GPU information
      shell: |
        if command -v rocm-smi &> /dev/null; then
          rocm-smi --showproductname --showserial --showvbios || echo ""
        else
          echo ""
        fi
      register: amd_gpu_output
      changed_when: false
      ignore_errors: true

    - name: Get Intel GPU information
      shell: |
        lspci -v | grep -iA 10 "Intel.*Graphics" || echo ""
      register: intel_gpu_output
      changed_when: false
      ignore_errors: true

    - name: Get network adapter information and serial numbers
      shell: |
        lshw -C network -short 2>/dev/null || echo ""
      register: network_info
      changed_when: false
      ignore_errors: true

    - name: Get storage device information
      shell: |
        lsblk -o NAME,SIZE,TYPE,MODEL,SERIAL,VENDOR -d 2>/dev/null || echo ""
      register: storage_info
      changed_when: false
      ignore_errors: true

    - name: Build hardware metadata dictionary
      set_fact:
        hardware_metadata:
          hardware:
            cpu:
              architecture: "{{ ansible_architecture | default('unknown') }}"
              processor_count: "{{ ansible_processor_count | default(0) }}"
              processor_cores: "{{ ansible_processor_cores | default(0) }}"
              processor_threads_per_core: "{{ ansible_processor_threads_per_core | default(0) }}"
              processor_vcpus: "{{ ansible_processor_vcpus | default(0) }}"
              processor: "{{ ansible_processor | default([]) }}"
              lscpu_output: "{{ cpu_details.stdout | default('') }}"
              dmidecode_output: "{{ cpu_dmidecode.stdout | default('') }}"
            memory:
              memtotal_mb: "{{ ansible_memtotal_mb | default(0) }}"
              memfree_mb: "{{ ansible_memfree_mb | default(0) }}"
              swaptotal_mb: "{{ ansible_swaptotal_mb | default(0) }}"
              swapfree_mb: "{{ ansible_swapfree_mb | default(0) }}"
              dmidecode_output: "{{ memory_details.stdout | default('') }}"
            motherboard:
              product_name: "{{ ansible_product_name | default('unknown') }}"
              product_version: "{{ ansible_product_version | default('unknown') }}"
              dmidecode_output: "{{ motherboard_details.stdout | default('') }}"
            bios:
              bios_date: "{{ ansible_bios_date | default('unknown') }}"
              bios_version: "{{ ansible_bios_version | default('unknown') }}"
              dmidecode_output: "{{ bios_details.stdout | default('') }}"
            system:
              system_vendor: "{{ ansible_system_vendor | default('unknown') }}"
              product_name: "{{ ansible_product_name | default('unknown') }}"
              product_serial: "{{ ansible_product_serial | default('unknown') }}"
              product_uuid: "{{ ansible_product_uuid | default('unknown') }}"
              dmidecode_output: "{{ system_details.stdout | default('') }}"
            gpu:
              lspci_output: "{{ gpu_lspci.stdout | default('') }}"
              lspci_detailed: "{{ gpu_lspci_detailed.stdout | default('') }}"
              nvidia:
                driver_version: "{{ nvidia_driver_version.stdout | default('') }}"
                cuda_version: "{{ cuda_version_smi.stdout | default('') }}"
                cuda_toolkit_version: "{{ cuda_nvcc_version.stdout | default('') }}"
                cuda_runtime: "{{ cuda_runtime_version.stdout | default('') }}"
                smi_output: "{{ nvidia_smi_output.stdout | default('') }}"
                detailed_info: "{{ nvidia_gpu_detailed.stdout | default('') }}"
                persistence_mode: "{{ nvidia_persistence_mode.stdout | default('') }}"
                compute_mode: "{{ nvidia_compute_mode.stdout | default('') }}"
                topology: "{{ nvidia_topology.stdout | default('') }}"
              amd:
                rocm_output: "{{ amd_gpu_output.stdout | default('') }}"
              intel:
                output: "{{ intel_gpu_output.stdout | default('') }}"
            network:
              devices: "{{ ansible_interfaces | default([]) }}"
              lshw_output: "{{ network_info.stdout | default('') }}"
            storage:
              devices: "{{ ansible_devices | default({}) }}"
              lsblk_output: "{{ storage_info.stdout | default('') }}"
      ignore_errors: true

    - name: Ensure metadata directory exists
      file:
        path: "{{ metadata_path | dirname }}"
        state: directory
        mode: '0755'
      ignore_errors: true

    - name: Check if metadata.json exists
      stat:
        path: "{{ metadata_path }}"
      register: metadata_file
      ignore_errors: true

    - name: Read existing metadata.json if it exists
      slurp:
        path: "{{ metadata_path }}"
      register: existing_metadata
      when: metadata_file.stat.exists
      ignore_errors: true

    - name: Parse existing metadata
      set_fact:
        existing_metadata_dict: "{{ existing_metadata.content | b64decode | from_json }}"
      when: metadata_file.stat.exists and existing_metadata.content is defined
      ignore_errors: true

    - name: Initialize empty metadata if file doesn't exist
      set_fact:
        existing_metadata_dict: {}
      when: not metadata_file.stat.exists or existing_metadata.content is not defined
      ignore_errors: true

    - name: Merge hardware metadata with existing metadata
      set_fact:
        merged_metadata: "{{ existing_metadata_dict | combine(hardware_metadata, recursive=True) }}"
      ignore_errors: true

    - name: Write merged metadata to metadata file
      copy:
        content: "{{ merged_metadata | to_nice_json }}"
        dest: "{{ metadata_path }}"
        mode: '0644'
        backup: "{{ metadata_backup }}"
      ignore_errors: true

    - name: Display success message
      debug:
        msg: "Hardware metadata has been successfully collected and stored in {{ metadata_path }}"
      ignore_errors: true
